<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster - Records</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        body {
            background: linear-gradient(-45deg, #e3f2fd, #f3e5f5, #fce4ec, #e8f5e9);
            background-size: 400% 400%;
            animation: gradient 20s ease infinite;
        }
        .record-card {
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .record-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .chart-bar {
            transition: height 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
        }
        .chart-bar:hover {
            filter: brightness(1.2);
        }
        .stat-icon {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .filter-button {
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .filter-button:hover {
            transform: scale(1.1);
        }
        .table-row {
            transition: all 0.3s ease;
        }
        .table-row:hover {
            background: linear-gradient(90deg, #f3e5f5 0%, #e8f5e9 100%);
            transform: scale(1.01);
        }
        .pop-in {
            animation: pop-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .slide-up {
            animation: slide-up 0.6s ease-out;
        }
        @keyframes slide-up {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white bg-opacity-90 backdrop-blur-xl shadow-xl sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-2 rounded-xl">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">TaskMaster</h1>
                </div>
                <div class="flex space-x-2">
                    <a href="dashboard.html" class="px-4 py-2 text-gray-600 hover:bg-purple-50 rounded-lg font-semibold transition">Today</a>
                    <a href="monthly.html" class="px-4 py-2 text-gray-600 hover:bg-purple-50 rounded-lg font-semibold transition">Monthly</a>
                    <a href="rewards.html" class="px-4 py-2 text-gray-600 hover:bg-purple-50 rounded-lg font-semibold transition">Rewards</a>
                    <a href="records.html" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold rounded-lg transform hover:scale-105 transition shadow-lg">Records</a>
                    <button onclick="logout()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg font-semibold transition">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8 slide-up">
            <h2 class="text-5xl font-black text-gray-800 mb-2 flex items-center">
                <span class="mr-3 text-6xl">üìä</span>
                Task Records & Analytics
            </h2>
            <p class="text-gray-600 text-xl font-semibold">Track your productivity over time</p>
        </div>

        <!-- Filter Section -->
        <div class="bg-white bg-opacity-90 backdrop-blur-xl rounded-3xl shadow-2xl p-8 mb-8 pop-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <label class="block text-gray-700 text-sm font-black mb-3">üìÖ Date Range</label>
                    <select id="dateRange" onchange="filterRecords()" 
                        class="w-full px-4 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition font-semibold text-gray-700">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-black mb-3">‚úÖ Status</label>
                    <select id="statusFilter" onchange="filterRecords()"
                        class="w-full px-4 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition font-semibold text-gray-700">
                        <option value="all">All Tasks</option>
                        <option value="completed">Completed</option>
                        <option value="incomplete">Incomplete</option>
                        <option value="ontime">On Time</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-black mb-3">üéØ Priority</label>
                    <select id="priorityFilter" onchange="filterRecords()"
                        class="w-full px-4 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition font-semibold text-gray-700">
                        <option value="all">All Priorities</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-black mb-3">üîç Search</label>
                    <input type="text" id="searchBox" onkeyup="filterRecords()" placeholder="Search tasks..."
                        class="w-full px-4 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition font-semibold text-gray-700">
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-3xl p-8 text-white shadow-2xl transform hover:scale-105 transition-all duration-300 pop-in" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-blue-100 text-sm font-bold mb-2">Total Tasks</p>
                        <p class="text-6xl font-black" id="recordTotal">0</p>
                    </div>
                    <div class="text-6xl stat-icon">üìã</div>
                </div>
                <p class="text-blue-200 text-sm font-semibold">In selected period</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-emerald-700 rounded-3xl p-8 text-white shadow-2xl transform hover:scale-105 transition-all duration-300 pop-in" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-green-100 text-sm font-bold mb-2">Completion Rate</p>
                        <p class="text-6xl font-black" id="recordCompletionRate">0%</p>
                    </div>
                    <div class="text-6xl stat-icon">‚úÖ</div>
                </div>
                <p class="text-green-200 text-sm font-semibold">Tasks completed</p>
            </div>
            <div class="bg-gradient-to-br from-yellow-500 to-orange-600 rounded-3xl p-8 text-white shadow-2xl transform hover:scale-105 transition-all duration-300 pop-in" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-yellow-100 text-sm font-bold mb-2">On-Time Rate</p>
                        <p class="text-6xl font-black" id="recordOnTimeRate">0%</p>
                    </div>
                    <div class="text-6xl stat-icon">‚è∞</div>
                </div>
                <p class="text-yellow-200 text-sm font-semibold">Completed on time</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-indigo-700 rounded-3xl p-8 text-white shadow-2xl transform hover:scale-105 transition-all duration-300 pop-in" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-purple-100 text-sm font-bold mb-2">Average Daily</p>
                        <p class="text-6xl font-black" id="recordAvgDaily">0</p>
                    </div>
                    <div class="text-6xl stat-icon">üìà</div>
                </div>
                <p class="text-purple-200 text-sm font-semibold">Tasks per day</p>
            </div>
        </div>

        <!-- Activity Chart -->
        <div class="bg-white bg-opacity-90 backdrop-blur-xl rounded-3xl shadow-2xl p-8 mb-8 slide-up">
            <h3 class="text-3xl font-black text-gray-800 mb-6 flex items-center">
                <span class="mr-3">üìä</span>
                Daily Activity Chart
            </h3>
            <div class="flex items-end justify-between h-80 space-x-2" id="activityChart">
                <!-- Chart bars will be generated here -->
            </div>
            <div class="flex justify-between mt-6 text-sm text-gray-600 font-bold" id="chartLabels">
                <!-- Labels will be generated here -->
            </div>
        </div>

        <!-- Task Records Table -->
        <div class="bg-white bg-opacity-90 backdrop-blur-xl rounded-3xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-3xl font-black text-gray-800 flex items-center">
                    <span class="mr-3">üìë</span>
                    Task History
                </h3>
                <div class="flex space-x-3">
                    <button onclick="exportRecords('csv')" 
                        class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl text-sm font-bold hover:from-green-600 hover:to-emerald-700 transition transform hover:scale-105 shadow-lg">
                        üìä Export CSV
                    </button>
                    <button onclick="exportRecords('pdf')" 
                        class="px-6 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl text-sm font-bold hover:from-red-600 hover:to-pink-700 transition transform hover:scale-105 shadow-lg">
                        üìÑ Export PDF
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto rounded-2xl">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-black uppercase tracking-wider rounded-tl-xl">Date</th>
                            <th class="px-6 py-4 text-left text-sm font-black uppercase tracking-wider">Task</th>
                            <th class="px-6 py-4 text-left text-sm font-black uppercase tracking-wider">Time</th>
                            <th class="px-6 py-4 text-left text-sm font-black uppercase tracking-wider">Priority</th>
                            <th class="px-6 py-4 text-left text-sm font-black uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-left text-sm font-black uppercase tracking-wider rounded-tr-xl">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTable" class="divide-y divide-gray-200">
                        <!-- Records will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-between mt-8">
                <p class="text-sm text-gray-700 font-bold">
                    Showing <span id="showingStart" class="text-purple-600">1</span> to <span id="showingEnd" class="text-purple-600">10</span> of <span id="totalRecords" class="text-purple-600">0</span> records
                </p>
                <div class="flex space-x-3">
                    <button onclick="changePage(-1)" id="prevBtn"
                        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl text-sm font-bold hover:bg-gray-300 transition transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚Üê Previous
                    </button>
                    <button onclick="changePage(1)" id="nextBtn"
                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl text-sm font-bold hover:from-purple-700 hover:to-indigo-700 transition transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
<script>
    let allRecords = [];
    let filteredRecords = [];
    let currentPage = 1;
    const recordsPerPage = 10;

    // Check authentication
    if (!getToken()) {
        window.location.href = 'login.html';
    }

    function init() {
        loadRecords();
        generateActivityChart();
    }

    async function loadRecords() {
        try {
            const dateRange = parseInt(document.getElementById('dateRange').value);
            const response = await analyticsAPI.get(dateRange);
            
            // Get all tasks for the period
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - dateRange);
            
            const tasksResponse = await tasksAPI.getAll({
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            });
            
            allRecords = tasksResponse.tasks || [];
            filterRecords();
        } catch (error) {
            console.error('Error loading records:', error);
            showNotification('Failed to load records', 'error');
        }
    }

    function filterRecords() {
        const status = document.getElementById('statusFilter').value;
        const priority = document.getElementById('priorityFilter').value;
        const search = document.getElementById('searchBox').value.toLowerCase();

        filteredRecords = allRecords.filter(record => {
            const matchesStatus = status === 'all' || 
                (status === 'completed' && record.completed) ||
                (status === 'incomplete' && !record.completed) ||
                (status === 'ontime' && record.completedOnTime);
            const matchesPriority = priority === 'all' || record.priority === priority;
            const matchesSearch = record.title.toLowerCase().includes(search);

            return matchesStatus && matchesPriority && matchesSearch;
        });

        currentPage = 1;
        updateSummaryStats();
        renderRecordsTable();
        generateActivityChart();
    }

    function updateSummaryStats() {
        const total = filteredRecords.length;
        const completed = filteredRecords.filter(r => r.completed).length;
        const onTime = filteredRecords.filter(r => r.completedOnTime).length;
        const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
        const onTimeRate = completed > 0 ? Math.round((onTime / completed) * 100) : 0;
        const dateRange = parseInt(document.getElementById('dateRange').value);
        const avgDaily = total > 0 ? (total / dateRange).toFixed(1) : 0;

        animateValue('recordTotal', 0, total, 1000);
        setTimeout(() => {
            document.getElementById('recordCompletionRate').textContent = completionRate + '%';
            document.getElementById('recordOnTimeRate').textContent = onTimeRate + '%';
            document.getElementById('recordAvgDaily').textContent = avgDaily;
        }, 500);
    }

    function renderRecordsTable() {
        const start = (currentPage - 1) * recordsPerPage;
        const end = start + recordsPerPage;
        const pageRecords = filteredRecords.slice(start, end);

        const tbody = document.getElementById('recordsTable');
        
        if (pageRecords.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center"><div class="text-6xl mb-4">üì≠</div><p class="text-gray-500 text-xl font-bold">No records found</p></td></tr>';
            return;
        }

        const priorityColors = {
            high: 'bg-red-100 text-red-700 border-red-500',
            medium: 'bg-yellow-100 text-yellow-700 border-yellow-500',
            low: 'bg-green-100 text-green-700 border-green-500'
        };

        tbody.innerHTML = pageRecords.map((record, index) => `
            <tr class="table-row pop-in" style="animation-delay: ${index * 0.05}s">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${record.date.split('T')[0]}</td>
                <td class="px-6 py-4 text-sm font-bold text-gray-900">${record.title}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-600">‚è∞ ${record.time}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-4 py-2 text-xs font-black rounded-xl ${priorityColors[record.priority]} border-2 shadow-sm">
                        ${record.priority.toUpperCase()}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${record.completed ? 
                        (record.completedOnTime ? 
                            '<span class="px-4 py-2 text-xs font-black rounded-xl bg-green-100 text-green-700 border-2 border-green-500 shadow-sm">‚úì On Time</span>' :
                            '<span class="px-4 py-2 text-xs font-black rounded-xl bg-blue-100 text-blue-700 border-2 border-blue-500 shadow-sm">‚úì Completed</span>'
                        ) :
                        '<span class="px-4 py-2 text-xs font-black rounded-xl bg-gray-100 text-gray-700 border-2 border-gray-400 shadow-sm">Incomplete</span>'
                    }
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="viewRecord('${record._id}')" 
                        class="text-purple-600 hover:text-purple-800 font-black transform hover:scale-110 transition">üëÅÔ∏è View</button>
                </td>
            </tr>
        `).join('');

        document.getElementById('showingStart').textContent = start + 1;
        document.getElementById('showingEnd').textContent = Math.min(end, filteredRecords.length);
        document.getElementById('totalRecords').textContent = filteredRecords.length;

        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = end >= filteredRecords.length;
    }

    async function generateActivityChart() {
        try {
            const dateRange = parseInt(document.getElementById('dateRange').value);
            const response = await analyticsAPI.get(dateRange);
            const chartData = response.analytics.dailyActivity;

            const maxValue = Math.max(...chartData.map(d => d.total), 1);
            const chart = document.getElementById('activityChart');
            const labels = document.getElementById('chartLabels');

            chart.innerHTML = chartData.map((day, index) => `
                <div class="flex-1 flex flex-col items-center justify-end pop-in" style="animation-delay: ${index * 0.05}s">
                    <div class="relative w-full group">
                        <div class="chart-bar bg-gradient-to-t from-purple-600 to-indigo-500 w-full rounded-t-xl hover:from-purple-700 hover:to-indigo-600 transition cursor-pointer shadow-lg" 
                            style="height: ${(day.total / maxValue) * 280}px"
                            title="${day.date}: ${day.completed}/${day.total} completed">
                        </div>
                        <div class="absolute -top-12 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition whitespace-nowrap font-bold shadow-xl">
                            ${day.completed}/${day.total} ‚úì
                        </div>
                    </div>
                </div>
            `).join('');

            const days = chartData.length;
            labels.innerHTML = chartData.map((day, i) => {
                const date = new Date(day.date);
                const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                return i % Math.ceil(days / 7) === 0 ? `<div class="flex-1 text-center">${label}</div>` : '<div class="flex-1"></div>';
            }).join('');
        } catch (error) {
            console.error('Error generating chart:', error);
        }
    }

    function changePage(direction) {
        currentPage += direction;
        renderRecordsTable();
        window.scrollTo({ top: 400, behavior: 'smooth' });
    }

    function viewRecord(id) {
        const record = allRecords.find(r => r._id === id);
        if (record) {
            const statusEmoji = record.completed ? (record.completedOnTime ? '‚úÖ' : '‚úì') : '‚è≥';
            alert(`üìã Task Details\n\nDate: ${record.date.split('T')[0]}\nTask: ${record.title}\nTime: ${record.time}\nPriority: ${record.priority.toUpperCase()}\nStatus: ${statusEmoji} ${record.completed ? (record.completedOnTime ? 'Completed On Time' : 'Completed Late') : 'Incomplete'}\nPoints: ${record.pointsEarned || 0}`);
        }
    }

    function exportRecords(format) {
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - parseInt(document.getElementById('dateRange').value));
        const endDate = new Date();
        
        if (format === 'csv') {
            exportAPI.csv(startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0]);
        } else if (format === 'pdf') {
            exportAPI.pdf(startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0]);
        }
        showNotification(`üìä Exporting ${filteredRecords.length} records as ${format.toUpperCase()}...`, 'info');
    }

    function animateValue(id, start, end, duration) {
        const element = document.getElementById(id);
        const range = end - start;
        const increment = range / (duration / 16);
        let current = start;
        
        const timer = setInterval(() => {
            current += increment;
            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                current = end;
                clearInterval(timer);
            }
            element.textContent = Math.round(current);
        }, 16);
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-4 bg-white px-6 py-4 rounded-2xl shadow-2xl z-50 transform translate-x-full transition-all duration-500 border-l-4 ${
            type === 'success' ? 'border-green-500' : type === 'error' ? 'border-red-500' : 'border-blue-500'
        }`;
        notification.innerHTML = `<p class="font-bold text-gray-800">${message}</p>`;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.style.transform = 'translateX(0)', 100);
        setTimeout(() => {
            notification.style.transform = 'translateX(150%)';
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            authAPI.logout();
        }
    }

    init();
</script>
</body>
</html>